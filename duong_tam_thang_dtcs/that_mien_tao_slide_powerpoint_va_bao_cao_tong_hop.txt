
```{r}
#| include: false
# Tạo slide báo cáo từ file template
my_pres  <- read_pptx("template.pptx") 

myftr <- "Bệnh viện 30-4"
```

```{r}
#| eval: false
#| include: false
#Kiểm tra layout (option)
layout_summary(my_pres)

glimpse(layout_summary(my_pres))
# Inspect layout structure
knitr::kable(layout_summary(my_pres))

# Inspect properties of a specific layout
knitr::kable(layout_properties(my_pres, layout = "Title and Content", master = "Office Theme"))


```

```{r}
#| include: false
# Tạo slide tiêu đề
# Add title slide
my_pres <- add_slide(my_pres, layout = "Title Slide", master = "Office Theme")

# Add title and subtitle
my_pres <- ph_with(my_pres, value = "Đánh giá hiệu quả điều trị mất ngủ bằng phương pháp sử dụng châm cứu kết hợp với bài thuốc “Dưỡng tâm thang” trên bệnh nhân mất ngủ thể tâm âm hư tại Bệnh viện 30-4 ",
                   location = ph_location_type(type = "ctrTitle"))
my_pres <- ph_with(my_pres, value = " YHCT team BV 30-4", 
                   location = ph_location_type(type = "subTitle"))

# Add footer
my_pres <- ph_with(my_pres, value = "ĐV chủ trì: Khoa YHCT", location = ph_location_type(type = "ftr"))
# Add footer with date
my_pres <- ph_with(my_pres, value = format(Sys.Date(), "%d/%m/%Y"), location = ph_location_type(type = "dt"))
# Add infor to footer

my_pres <- ph_with(my_pres, value = "Đề tài cấp cơ sở", location = ph_location_type(type = "sldNum"))
```

```{r}
#| include: false
# Slide nội dung
ul <- unordered_list(
  level_list = c(1, 1, 1,1 ),
  str_list = c("Đặt vấn đề", "Đối tượng và phương pháp nghiên cứu", "Kết quả - Bàn luận", "Kết luận"),
  style = fp_text(color = "black", font.size = 0) )


my_pres  <- add_slide(my_pres , layout = "Title and Content", master = "Office Theme")

my_pres <- ph_with(my_pres, value = "Nội dung trình bày", location = ph_location_type(type = "title"))
my_pres <- ph_with(x = my_pres, value = ul, 
               location = ph_location_type(type = "body") )


```

```{r}
#| include: false
## Slide nội dung

ul <- unordered_list(
  level_list = c(1, 2,  1, 2, 2,2),
  str_list = c("
               Câu hỏi nghiên cứu", 
               "Ở bệnh nhân mất ngủ, điều trị bằng phương pháp sử dụng bài thuốc sắc Dưỡng tâm thang phối hợp châm cứu kết có tốt hơn phương pháp châm cứu hay không?", 
               "Mục tiêu", 
               "Đánh giá hiệu quả điều trị mất ngủ bằng phương pháp sử dụng châm cứu kết hợp với bài thuốc Dưỡng tâm thang trên bệnh nhân mất ngủ thể tâm âm hư tại Bệnh viện 30-4", 
               "So sánh hiệu quả điều trị mất ngủ thể tâm âm hư bằng phương pháp sử dụng châm cứu kết hợp với bài thuốc Dưỡng tâm thang trên bệnh nhân mất ngủ thể tâm âm hư với phương pháp chỉ sử dụng châm cứu" , 
               "Khảo sát tác dụng của không mong muốn phương pháp điều trị"),
  style = fp_text(color = "black", font.size = 0) )


my_pres  <- add_slide(my_pres , layout = "Title and Content", master = "Office Theme")

my_pres <- ph_with(my_pres, value = "Câu hỏi NC, mục tiêu", location = ph_location_type(type = "title"))
my_pres <- ph_with(x = my_pres, value = ul, 
               location = ph_location_type(type = "body") )


```

```{r}
#| include: false
# Slide Đặt vấn đề
my_pres  <- add_slide(my_pres , layout = "Title and Content", master = "Office Theme")
# add title of slide
my_pres <- ph_with(my_pres, value = "Đặt vấn đề", location = ph_location_type(type = "title"))
# add body of slide
my_pres <- ph_with(my_pres, value = c(
  "Mất ngủ kéo dài sẽ gây căng thẳng, lo âu, làm tăng nặng nhiều bệnh mạn tính và ảnh hưởng trầm trọng tới năng suất lao động và gia tăng chi phí xã hội, chăm sóc y tế.",
  "Y học hiện điều trị chủ yếu tập trung vào thuốc giảm lo âu, an thần, khi sử dụng lâu dài những thuốc đó dần dẫn đến tình trạng lệ thuộc vào thuốc, mệt mỏi, suy giảm trí nhớ, ảnh hưởng đến chất lượng cuộc sống.
",
    "Bài thuốc “Dưỡng tâm thang là bài cổ phương có nguồn gốc từ sách “Cổ kim y thống” của Từ Xuân Phủ có tác dụng dưỡng huyết tư âm, dưỡng tâm an thần. Là một trong những phương pháp đã được chứng minh hiệu quả điều trị mất ngủ.
",
    "Phương pháp châm cứu sử dụng các huyệt thường sử dụng là Nội quan, Thần môn, Tam âm giao, An miên, Dũng tuyền mà một số huyệt đặc biệt đã được chứng minh hiệu quả trên lâm sàng và nhiều nghiên cứu trong và ngoài nước.",
    "Chúng tôi thực hiện nghiên cứu Đánh giá hiệu quả điều trị mất ngủ bằng phương pháp sử dụng châm cứu kết hợp với bài thuốc Dưỡng tâm thang trên bệnh nhân mất ngủ thể Tâm âm hư tại Bệnh viện 30-4"
  ), location = ph_location_type(type = "body"))


```

```{r}
#| include: false
# Slide đối tượng và phương pháp nghiên cứu
ul <- unordered_list(
  level_list = c(1, 2,  1, 2, 2,2,2, 1, 2, 2, 2),
  str_list = c(
    "Thiết kế ngiên cứu", 
    "Nghiên cứu can thiệp lâm sàng,so sánh hiệu quả 2 nhóm.", 
    "Tiêu chuẩn chọn", 
    "Bệnh nhân thoả mãn theo tiêu chuẩn chẩn đoán mất ngủ không thực tổn của ICD-10 ", 
    "Đánh giá chất lượng giấc ngủ theo thang điểm Pittsburgh (PSQI) tổng điểm >5 điểm", 
    "Bệnh nhân đồng ý và tự nguyện tham gia nghiên cứu sử dụng phác đồ nghiên cứu
",
    "Bệnh nhân thất miên thể tâm âm hư với triệu chứng và quy nạp theo tứ chẩn
",
    "Tiêu chuẩn loại trừ:", 
    "BN có kèm theo rối loạn trầm cảm nặng hoặc bệnh lý cấp tính", 
    "BN không hợp tác điều trị", 
    "BN không tái khám, không được đánh giá kết quả sau điều trị." 
    ),
  style = fp_text(color = "black", font.size = 0) )


my_pres  <- add_slide(my_pres , layout = "Title and Content", master = "Office Theme")

my_pres <- ph_with(my_pres, value = "Đối tượng và phương pháp nghiên cúu", location = ph_location_type(type = "title"))
my_pres <- ph_with(x = my_pres, value = ul, 
               location = ph_location_type(type = "body") )


```

```{r}
#| eval: false
#| include: false
## Slides Tiến độ lấy mẫu
my_pres  <- add_slide(my_pres , layout = "Title and Content", master = "Office Theme")


my_pres <- ph_with(my_pres, value = "Tiến độ lấy mẫu", location = ph_location_type(type = "title"))

emp <- as.data.frame(df %>% count(year) %>%  mutate(percentage = round((n / sum(n)) * 100),  1))




loc <- ph_location(
  left=1.5,
  top = 1.5,
  width = 10,
  height = 4,
  rotation = 0,
  bg="#333333"
)

my_pres  <- ph_with(my_pres , emp, location = loc)

```

```{r}
#| include: false
## Add more slide
my_pres  <- add_slide(my_pres , layout = "Title and Content", master = "Office Theme")
# add title of slide
my_pres <- ph_with(my_pres, value = "Current study", location = ph_location_type(type = "title"))
# add body of slide
my_pres <- ph_with(my_pres, value = c(
  "Thời gian đi vào giấc ngủ",
  "Thời lượng giấc ngủ",  
  "Hiệu quả giấc ngủ (hiệu suất)",  
  "Rối loạn trong giấc ngủ",  
  "Chất lượng giấc ngủ theo đánh giá chủ quan"
  ), location = ph_location_type(type = "body"))
```

```{r}
#| include: false
# add ggplot

my_pres  <- add_slide(my_pres , layout = "Title and Content", master = "Office Theme")


my_pres <- ph_with(my_pres, value = "cho ggplot vô body", location = ph_location_type(type = "title"))

  
my_pres <- ph_with(x = my_pres, tuoi_pl, 
   location = ph_location_type(type = "body") )

```

```{r}
#| eval: false
#| include: false
# add table slide
my_pres <- add_slide(my_pres, layout = "Title and Content", master = "Office Theme") #them slides
my_pres <- ph_with(my_pres, value = "Đặc điểm giới tính -giữa ", location = ph_location_type(type = "title")) #them title

# summary bang
gender_summary <- df %>%
  group_by(Gender) %>%
  summarise(
    Count = n(),
    Percentage = round((n() / nrow(df)) * 100, 1)
  ) %>%
  ungroup()

# Create and format the flextable
ft <- flextable(gender_summary) %>%
  set_header_labels(Gender = "Giới tính", Count = "n", Percentage = "%")  %>%
  fontsize(size = 18, part = "header") %>% bold(bold = TRUE, part = "header") %>% bg( bg = "#D3D3D3", part = "header") %>%
  fontsize(size = 18, part = "body") %>%   autofit()

ft <- width(ft, width = 5, unit = "cm")

# Get slide dimensions in inches
slide_dims <- slide_size(my_pres)
slide_width <- slide_dims$width
slide_height <- slide_dims$height

# Get flextable dimensions
table_dims <- dim(ft)
table_width <- sum(table_dims$widths)
table_height <- sum(table_dims$heights)

# Calculate positions to center the table
left_pos <- (slide_width - table_width) / 2
top_pos <- (slide_height - table_height) / 2


# Add the flextable to the slide at the calculated position
my_pres <- ph_with(my_pres, value = ft, location = ph_location(left = left_pos, top = top_pos))



```

```{r}
#| include: false
#  slide với bảng 2 nội dung

#| echo: true
my_pres <- add_slide(my_pres, layout = "Two Content", master = "Office Theme") #them slides
my_pres <- ph_with(my_pres, value = "Đặc điểm giới tính (Bản và biểu đồ) ", location = ph_location_type(type = "title")) #them title

# summary bang
gender_summary <- df %>%
  group_by(Gender) %>%
  summarise(
    Count = n(),
    Percentage = round((n() / nrow(df)) * 100, 1)
  ) %>%
  ungroup()

# Create and format the flextable
ft <- flextable(gender_summary) %>%
  set_header_labels(Gender = "Giới tính", Count = "n", Percentage = "%")  %>%
  fontsize(size = 16, part = "header") %>% bold(bold = TRUE, part = "header") %>% bg( bg = "#D3D3D3", part = "header") %>%
  fontsize(size = 16, part = "body") %>%   autofit()

ft <- width(ft, width = 3, unit = "cm")

# Dat bieu do ben phai
my_pres <- ph_with( my_pres,  value = tuoi_pl
,   location = ph_location_label(ph_label = "Content Placeholder 3"))


# Dat bang ben T

my_pres <- ph_with( my_pres,  value = ft,   location = ph_location_label(ph_label = "Content Placeholder 2"))




```

```{r}
#| eval: false
#| include: false

## bảng 2

my_pres  <- add_slide(my_pres , layout = "Title and Content", master = "Office Theme")

 
my_pres <- ph_with(my_pres, value = "Thêm bảng nữa", location = ph_location_type(type = "title"))

ft <- flextable(head(mtcars))
ft <- set_table_properties(ft, width = 1, layout = "autofit")

my_pres <- ph_with(x = my_pres, ft, location = ph_location_type(type = "body")  )

```

```{r}
#| include: false
# Export to pptx file
print(my_pres , "that_mien_quarto.pptx")
```

```{r}
#| include: false
# Tạo file words báo cáo
rd <- read_docx() 

rd <- rd %>% 
  body_add_docx(src = "00_bia.docx") %>% 

  body_add_break()
# Get current date and time
current_day <- lubridate::now() %>% format('%d/%m/%Y')
current_time <- lubridate::now() %>% format('%H:%M')

prop_red_text <- fp_text(
    color = "red",
    font.size = 16,
    bold = TRUE
)
# Create the formatted text for the report as a single string

text_creation_time <- ftext(
  glue::glue(
    'Báo cáo được tạo ra vào {current_time} ngày {current_day} bởi TEAM YHCT.',
  ),
  prop = prop_red_text
)
# Create the ftext object for formatted text
#par_creation_time <- fpar(text_creation_time)

par_creation_time <- fpar(
  text = text_creation_time,

  fp_p = fp_par(
    text.align = "right",
    border.top = fp_border(
      width = 2,
      color = "blue"
    )
  )
)


rd <- rd %>%
  body_add_fpar(par_creation_time) %>%

body_add_break()
  
  rd <- rd %>%  
  body_add_par("MỤC LỤC", style = "centered") %>% 
  body_add_toc(level = 2) %>% 
  body_add_par("Table of figures", style = "heading 1") %>% 
  body_add_toc(style = "Image Caption") %>% 
  body_add_par("Table of tables", style = "heading 1") %>% 
  body_add_toc(style = "Table Caption") %>% 
  body_add_break()  
  

  rd <- rd %>%
    body_add_par(value = "BÁO CÁO TÓM TẮT NGHIÊU CỨU", style = "centered") %>%
    body_add_par(value = "Team YHCT", style = "Normal") %>%

    
  
  body_add_par(value = "Tổng quan mất ngủ.", style = "heading 1") %>% 
  body_add_par(value = "Vai trò dưỡng tâm thang YHCT.", style = "heading 2") %>% 
  body_add_par(value = "Các nghiên cứu trong nước liên quan ", style = "heading 3") %>% 
  
  body_add_par(value = "Báo cáo tiến độ ", style = "heading 3") %>%  
  body_add_par(value = "Báo cáo tiến độ theo năm", style = "Normal") %>% 
  
  body_add_gg(value = tuoi_pl , style = "centered") %>%
  body_add_par(value = "Báo cáo tuổi", style = "Normal") %>% 
   
  body_add_gg(value = tuoi_pl , style = "centered") %>%
  body_add_par(value = "Đặc điểm giới tính ", style = "heading 3") 
  


# Create the flextable
ft <- table_ft %>%
  set_header_labels(Gender = "Tuổi", Count = "n", Percentage = "%") %>%
  set_table_properties(layout = "autofit") %>%
  autofit() %>%
  width(j = 1:3, width = 5, unit = "cm")  

rd <- rd %>% body_add_flextable(value = ft)

  
  rd %>% body_add_gg(value = tuoi_pl , style = "centered") %>%
    
    # Thêm thuyết minh đề tài 
  body_add_par(value = "Thuyết minh đề tài", style = "heading 1") %>% 
    body_add_docx(src = "thuyet_minh.docx") %>%
    
  # Thêm li lich khoa học
    body_add_par(value = "Lý lịch khoa học", style = "heading 1") %>% 
    body_add_docx(src = "llkh.docx") %>%
  print(target = "that_mien_dtcs_2025.docx")
```

######### Tài liệu tham khảo

---
title: "CÃ¡ch quáº£n lÃ½ citation vÃ  kiá»ƒm tra citation bá»‹ trÃ¹ng láº¯p"
author: "Henry Do"
date: today
format:
  html:
    toc: true
    toc-location: right
    code-fold: true
    code-summary: "Hiá»ƒn thá»‹/RÃºt gá»n mÃ£ R"
editor: source
---

## ğŸ“¦ Náº¡p thÆ° viá»‡n phÃ¢n tÃ­ch citation
```{r}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(bib2df, tidyverse, flextable, officer, glue, scales, rvg, forcats, citr)
```

## ğŸ“‚ Äá»c bib file vÃ o dataframe
```{r}
#| echo: true
#| message: false
#| warning: false
#| paged-print: false
# Äá»c dá»¯ liá»‡u tá»« file BibTeX
bib_lines <- readLines("sstt_reference.bib")
bib_line_index <- which(str_detect(bib_lines, "^@"))

# Äá»c bib thÃ nh dataframe vÃ  gáº¯n dÃ²ng
tltk <- bib2df("sstt_reference.bib") %>%
  mutate(Line = bib_line_index)

# Kiá»ƒm tra Ä‘á»™ dÃ i Ä‘á»ƒ Ä‘áº£m báº£o gáº¯n dÃ²ng khá»›p
stopifnot(length(bib_line_index) == nrow(bib2df("sstt_reference.bib")))

# ThÃ´ng bÃ¡o gáº¯n dÃ²ng
glue("ğŸ“ Gáº¯n thÃ nh cÃ´ng sá»‘ dÃ²ng tá»« file .bib vÃ o {nrow(tltk)} má»¥c.")
```

## ğŸ“š MÃ´ táº£ danh sÃ¡ch citation tá»« file BibTeX
```{r}
citation_summary <- tltk %>%
  mutate(
    AUTHOR = map_chr(AUTHOR, ~ if (is.null(.x) || all(is.na(.x))) NA_character_ else str_c(.x, collapse = ", ")),
    EDITOR = map_chr(EDITOR, ~ if (is.null(.x) || all(is.na(.x))) NA_character_ else str_c(.x, collapse = ", ")),
    AUTHOR = str_trunc(AUTHOR, 50),
    TITLE = str_trunc(TITLE, 80),
    YEAR = as.character(YEAR),
    STT = row_number()
  ) %>%
  select(STT, Line, BIBTEXKEY, AUTHOR, EDITOR, TITLE, YEAR, CATEGORY, JOURNAL, PUBLISHER)

glue("ğŸ“Œ CÃ³ tá»•ng cá»™ng {nrow(citation_summary)} má»¥c trÃ­ch dáº«n trong file BibTeX.")

flextable::flextable(citation_summary) %>%
  flextable::set_caption("ğŸ“š Báº£ng mÃ´ táº£ cÃ¡c má»¥c trÃ­ch dáº«n tá»« file BibTeX") %>%
  flextable::autofit()
```

## ğŸ“Š Biá»ƒu Ä‘á»“ sá»‘ lÆ°á»£ng citation theo nÄƒm (YEAR)
```{r}
year_summary <- tltk %>%
  filter(!is.na(YEAR)) %>%
  count(YEAR) %>%
  mutate(percent = n / sum(n) * 100)

ggplot(year_summary, aes(x = factor(YEAR), y = n, fill = factor(YEAR))) +
  geom_col(show.legend = FALSE) +
  geom_text(aes(label = glue("{n} ({round(percent,1)}%)")), vjust = -0.5, size = 3.5) +
  labs(
    title = "Sá»‘ lÆ°á»£ng citation theo nÄƒm xuáº¥t báº£n",
    x = "NÄƒm xuáº¥t báº£n",
    y = "Sá»‘ citation"
  ) +
  theme_minimal()
```

## ğŸ“Š Biá»ƒu Ä‘á»“ sá»‘ lÆ°á»£ng citation theo loáº¡i tÃ i liá»‡u (CATEGORY)
```{r}
category_summary <- tltk %>%
  filter(!is.na(CATEGORY)) %>%
  count(CATEGORY) %>%
  mutate(percent = n / sum(n) * 100)

ggplot(category_summary, aes(x = fct_reorder(CATEGORY, n), y = n, fill = CATEGORY)) +
  geom_col(show.legend = FALSE) +
  geom_text(aes(label = glue("{n} ({round(percent,1)}%)")), hjust = -0.1, size = 3.5) +
  coord_flip() +
  labs(
    title = "Sá»‘ lÆ°á»£ng citation theo loáº¡i tÃ i liá»‡u",
    x = "Loáº¡i tÃ i liá»‡u (BibTeX)",
    y = "Sá»‘ lÆ°á»£ng"
  ) +
  theme_minimal()
```

## ğŸ” Kiá»ƒm tra trÃ¹ng tiÃªu Ä‘á» citation
```{r}

duplicated_entries <- tltk %>% filter(duplicated(str_squish(str_to_lower(TITLE))))
glue("ğŸ” PhÃ¡t hiá»‡n {nrow(duplicated_entries)} má»¥c trÃ­ch dáº«n cÃ³ tiÃªu Ä‘á» bá»‹ trÃ¹ng sau khi chuáº©n hÃ³a.")

flextable::flextable(
  duplicated_entries %>% mutate(STT = row_number()) %>% select(STT, Line, BIBTEXKEY, TITLE, YEAR, JOURNAL, DOI, PAGES)
) %>%
  flextable::set_caption("ğŸ“„ CÃ¡c má»¥c trÃ­ch dáº«n bá»‹ trÃ¹ng tiÃªu Ä‘á» (Ä‘Ã£ chuáº©n hÃ³a)") %>%
  flextable::autofit()
```

## ğŸ“Š CÃ¡c tiÃªu Ä‘á» bá»‹ trÃ¹ng (Top 10)
```{r}
title_count <- tltk %>% count(TITLE, sort = TRUE) %>% filter(n > 1)

ggplot(title_count %>% slice_max(n, n = 10),
       aes(x = reorder(TITLE, n), y = n)) +
  geom_col(fill = "tomato") +
  geom_text(aes(label = n), hjust = -0.2, size = 3.5) +
  coord_flip() +
  labs(
    title = "ğŸ” CÃ¡c tiÃªu Ä‘á» trÃ­ch dáº«n bá»‹ trÃ¹ng (Top 10)",
    x = "TiÃªu Ä‘á» (Ä‘Ã£ chuáº©n hoÃ¡)",
    y = "Sá»‘ láº§n xuáº¥t hiá»‡n"
  ) +
  theme_minimal()
```

## ğŸ”¥ Heatmap tiÃªu Ä‘á» trÃ¹ng theo nÄƒm
```{r}
heat_data <- tltk %>% count(TITLE, YEAR) %>% filter(n > 1)

ggplot(heat_data, aes(x = factor(YEAR), y = fct_reorder(TITLE, n), fill = n)) +
  geom_tile(color = "white") +
  geom_text(aes(label = n), color = "black", size = 3) +
  scale_fill_gradient(low = "lightyellow", high = "red") +
  labs(
    title = "ğŸ”¥ Heatmap cÃ¡c tiÃªu Ä‘á» trÃ­ch dáº«n bá»‹ trÃ¹ng theo nÄƒm",
    x = "NÄƒm xuáº¥t báº£n",
    y = "TiÃªu Ä‘á» (Ä‘Ã£ chuáº©n hoÃ¡)",
    fill = "Sá»‘ láº§n trÃ¹ng"
  ) +
  theme_minimal() +
  theme(axis.text.y = element_text(size = 8))
```

## ğŸ§¾ TrÃ¹ng tiÃªu Ä‘á» + nÄƒm xuáº¥t báº£n
```{r}
duplicated_title_year <- tltk %>% group_by(TITLE, YEAR) %>% filter(n() > 1) %>% ungroup()

flextable::flextable(duplicated_title_year %>% mutate(STT = row_number()) %>% select(STT, Line, everything()))

glue("ğŸ” CÃ³ {nrow(duplicated_title_year)} má»¥c trÃ¹ng tiÃªu Ä‘á» vÃ  nÄƒm xuáº¥t báº£n")
```

## ğŸ†” TrÃ¹ng mÃ£ BIBTEXKEY
```{r}
duplicated_keys <- tltk %>% filter(duplicated(BIBTEXKEY) | duplicated(BIBTEXKEY, fromLast = TRUE))

flextable::flextable(duplicated_keys %>% mutate(STT = row_number()) %>% select(STT, everything()))

glue("âš ï¸ CÃ³ {nrow(duplicated_keys)} má»¥c cÃ³ BIBTEXKEY trÃ¹ng nhau!")
```

## ğŸ’¡ Gá»£i Ã½ giá»¯ hoáº·c loáº¡i citation nÃ o

```{r}
recommend_keep <- duplicated_entries %>%
  group_by(TITLE) %>%
  arrange(desc(!is.na(DOI)), desc(!is.na(JOURNAL)), desc(YEAR)) %>%
  slice(1) %>%
  ungroup()

recommend_drop <- duplicated_entries %>%
  filter(!BIBTEXKEY %in% recommend_keep$BIBTEXKEY)
```

### ğŸ“Œ Danh sÃ¡ch BIBTEXKEY nÃªn loáº¡i bá»
```{r}
drop_keys <- recommend_drop$BIBTEXKEY
glue("ğŸ—‘ï¸ Danh sÃ¡ch BIBTEXKEY nÃªn loáº¡i bá» (tá»•ng cá»™ng {length(drop_keys)} má»¥c):")
drop_keys
```

### ğŸ’¾ Xuáº¥t danh sÃ¡ch BIBTEXKEY cáº§n loáº¡i bá» ra file
```{r}
# Xuáº¥t danh sÃ¡ch BIBTEXKEY cáº§n loáº¡i bá»
writeLines(drop_keys, "bibtexkey_loai_bo.txt")
write_csv(tibble(BIBTEXKEY = drop_keys), "bibtexkey_loai_bo.csv")
glue("âœ… ÄÃ£ xuáº¥t danh sÃ¡ch {length(drop_keys)} BIBTEXKEY cáº§n loáº¡i bá» ra 2 file: bibtexkey_loai_bo.txt vÃ  bibtexkey_loai_bo.csv")

# Hiá»ƒn thá»‹ báº£ng citation nÃªn giá»¯ láº¡i
flextable(recommend_keep %>% mutate(STT = row_number()) %>% select(STT, Line, BIBTEXKEY, TITLE, YEAR, JOURNAL, DOI)) %>%
  set_caption("âœ… Gá»£i Ã½ giá»¯ láº¡i cÃ¡c citation tá»‘t nháº¥t (cÃ³ DOI, táº¡p chÃ­, nÄƒm má»›i hÆ¡n)") %>%
  colformat_int(j = "Line", prefix = "ğŸ“„ DÃ²ng ") %>%
  color(i = ~ Line > 500, j = "Line", color = "red") %>%
  add_footer_lines("ğŸ“Œ Báº¡n cÃ³ thá»ƒ tra cá»©u dÃ²ng nÃ y trá»±c tiáº¿p trong file .bib") %>%
  autofit()

# Hiá»ƒn thá»‹ báº£ng citation nÃªn loáº¡i bá»
flextable(recommend_drop %>% mutate(STT = row_number()) %>% select(STT, Line, BIBTEXKEY, TITLE, YEAR, JOURNAL, DOI)) %>%
  set_caption("ğŸ—‘ï¸ Gá»£i Ã½ loáº¡i bá» cÃ¡c citation trÃ¹ng kÃ©m Æ°u tiÃªn hÆ¡n") %>%
  colformat_int(j = "Line", prefix = "ğŸ“„ DÃ²ng ") %>%
  color(i = ~ Line > 500, j = "Line", color = "red") %>%
  add_footer_lines("ğŸ“Œ Báº¡n cÃ³ thá»ƒ tra cá»©u dÃ²ng nÃ y trá»±c tiáº¿p trong file .bib") %>%
  autofit()
```

### âœ¨ Gá»£i Ã½ tiÃªu chÃ­ loáº¡i bá»

- KhÃ´ng cÃ³ DOI hoáº·c ISSN rÃµ rÃ ng ğŸ“‰
- KhÃ´ng rÃµ nguá»“n (JOURNAL trá»‘ng hoáº·c nghi ngá») â“
- NÄƒm xuáº¥t báº£n cÅ© hÆ¡n báº£n khÃ¡c cÃ³ cÃ¹ng tiÃªu Ä‘á» â³
- BIBTEXKEY khÃ´ng nháº¥t quÃ¡n (tá»± Ä‘á»™ng sinh hoáº·c kÃ½ hiá»‡u táº¡m) ğŸ§©

> ğŸ‘‰ Báº¡n cÃ³ thá»ƒ kiá»ƒm tra thá»§ cÃ´ng trÆ°á»›c khi loáº¡i bá» Ä‘á»ƒ trÃ¡nh máº¥t trÃ­ch dáº«n quan trá»ng.

## ğŸ§¹ Loáº¡i bá» trÃ¹ng láº·p vÃ  xuáº¥t file sáº¡ch

## ğŸ“Š TÃ³m táº¯t sá»‘ lÆ°á»£ng trÃ­ch dáº«n trÃ¹ng láº·p
```{r}
tong_hop_trung <- tibble(
  Loai = c(
    "TrÃ¹ng tiÃªu Ä‘á»",
    "TrÃ¹ng tiÃªu Ä‘á» + nÄƒm",
    "TrÃ¹ng BIBTEXKEY",
    "Äá» xuáº¥t loáº¡i bá»"
  ),
  So_luong = c(
    nrow(duplicated_entries),
    nrow(duplicated_title_year),
    nrow(duplicated_keys),
    length(drop_keys)
  )
)

flextable(tong_hop_trung) %>%
  set_caption("ğŸ“Š TÃ³m táº¯t sá»‘ lÆ°á»£ng cÃ¡c loáº¡i trÃ­ch dáº«n bá»‹ trÃ¹ng hoáº·c Ä‘á» xuáº¥t loáº¡i bá»") %>%
  autofit()

# Biá»ƒu Ä‘á»“ tá»•ng há»£p
library(ggplot2)
ggplot(tong_hop_trung, aes(x = fct_reorder(Loai, So_luong), y = So_luong, fill = Loai)) +
  geom_col(show.legend = FALSE) +
  geom_text(aes(label = So_luong), hjust = -0.1, size = 4) +
  coord_flip() +
  labs(title = "ğŸ“Š Biá»ƒu Ä‘á»“ tá»•ng há»£p sá»‘ lÆ°á»£ng trÃ­ch dáº«n trÃ¹ng láº·p", x = NULL, y = "Sá»‘ lÆ°á»£ng") +
  theme_minimal()

# Nháº­n xÃ©t tá»± Ä‘á»™ng
most_common <- tong_hop_trung %>% arrange(desc(So_luong)) %>% slice(1)
least_common <- tong_hop_trung %>% arrange(So_luong) %>% slice(1)

if (nrow(tong_hop_trung) > 0) {
  glue("ğŸ“Œ Loáº¡i trÃ¹ng phá»• biáº¿n nháº¥t lÃ  '{most_common$Loai}' vá»›i {most_common$So_luong} má»¥c.
")
  glue("ğŸ“Œ Loáº¡i Ã­t gáº·p nháº¥t lÃ  '{least_common$Loai}' vá»›i {least_common$So_luong} má»¥c.
")
}
```
```


### ğŸ§¼ Tá»± Ä‘á»™ng loáº¡i bá» cÃ¡c citation theo gá»£i Ã½
```{r}
# XoÃ¡ cÃ¡c citation cÃ³ BIBTEXKEY náº±m trong danh sÃ¡ch cáº§n loáº¡i bá»
tltk_cleaned <- tltk %>% filter(!BIBTEXKEY %in% drop_keys)

# Kiá»ƒm tra láº¡i tá»•ng sá»‘ sau khi loáº¡i bá»
glue("âœ… Sau khi loáº¡i bá», cÃ²n láº¡i {nrow(tltk_cleaned)} má»¥c citation há»£p lá»‡.")
```

### ğŸ’¾ Xuáº¥t file BibTeX Ä‘Ã£ lÃ m sáº¡ch
```{r}
df2bib(tltk_cleaned, file = "cleaned_references_final.bib")
glue("ğŸ“ ÄÃ£ lÆ°u file BibTeX sáº¡ch tÃªn 'cleaned_references_final.bib'")
```
```{r}
tltk_unique <- tltk %>% distinct(TITLE, .keep_all = TRUE)
tltk_unique2 <- tltk %>% distinct(TITLE, YEAR, .keep_all = TRUE)
df2bib(tltk_unique, file = "cleaned_references.bib")
```

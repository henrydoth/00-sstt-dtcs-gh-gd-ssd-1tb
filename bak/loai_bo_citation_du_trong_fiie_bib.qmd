---
title: "Loai_bo_citation_du_trong_fiie_bib"
author: "Henry Do"
date: today
format:
  html:
    self-contained: true
    toc: true
    toc-location: right
    bibliography: cleaned_references_final.bib
    csl: ama.csl
    number-sections: true
    citation-location: margin
    code-fold: false
    code-summary: "Hi·ªÉn th·ªã/R√∫t g·ªçn m√£ R"
editor: source
---
# --- C√†i ƒë·∫∑t v√† n·∫°p th∆∞ vi·ªán c·∫ßn thi·∫øt ---
```{r}

if (!requireNamespace("bib2df", quietly = TRUE))
  install.packages("bib2df")
if (!requireNamespace("DT", quietly = TRUE))
  install.packages("DT")

library(bib2df)
library(stringr)
library(dplyr)
library(flextable)
library(glue)
```


```{r}
# Thi·∫øt l·∫≠p t√™n file
qmd_file <- "sstt_dtcs_quato_words_output.qmd"
bib_file <- "sstt_reference.bib"

# ƒê·ªçc file Quarto ƒë·ªÉ tr√≠ch xu·∫•t citation key
cit_keys <- readLines(qmd_file, encoding = "UTF-8") %>%
  str_extract_all("@[a-zA-Z0-9_\\-]+") %>%
  unlist() %>%
  str_remove("^@") %>%
  unique()

# ƒê·ªçc d·ªØ li·ªáu bib
bib_all <- bib2df(bib_file)

# G·∫Øn nh√£n "ƒê√£ d√πng" ho·∫∑c "B·ªã lo·∫°i"
bib_labeled <- bib_all %>%
  mutate(STATUS = if_else(BIBTEXKEY %in% cit_keys, "ƒê√£ d√πng", "B·ªã lo·∫°i"))

# T√≠nh to√°n th·ªëng k√™
summary_stat <- bib_labeled %>%
  summarise(
    tong = n(),
    dung = sum(STATUS == "ƒê√£ d√πng"),
    loai = sum(STATUS == "B·ªã lo·∫°i"),
    tile = round(loai / tong * 100, 1)
  ) %>%
  as.list()

# In th√¥ng tin th·ªëng k√™ ra HTML
summary_text <- glue(
  "### \U0001F4CA B√ÅO C√ÅO T√åNH H√åNH S·ª¨ D·ª§NG CITATION\n\n",
  "- T·ªïng s·ªë m·ª•c trong file BibTeX g·ªëc: **{summary_stat$tong}**\n",
  "- S·ªë citation ƒë∆∞·ª£c s·ª≠ d·ª•ng trong t√†i li·ªáu: **{summary_stat$dung}**\n",
  "- S·ªë citation KH√îNG ƒë∆∞·ª£c s·ª≠ d·ª•ng (b·ªã lo·∫°i): **{summary_stat$loai}**\n",
  "- T·ª∑ l·ªá b·ªã lo·∫°i b·ªè: **{summary_stat$tile}%**"
)
cat(summary_text)

# T·∫°o b·∫£ng ƒë·∫πp b·∫±ng flextable
bib_labeled %>%
  select(BIBTEXKEY, AUTHOR, TITLE, YEAR, JOURNAL, STATUS) %>%
  mutate(
    AUTHOR = sapply(AUTHOR, function(x) paste(x, collapse = ", ")),
    AUTHOR = stringr::str_trunc(AUTHOR, 50),
    TITLE = stringr::str_trunc(TITLE, 60)
  ) %>%
  flextable() %>%
  set_caption("üë∂ Danh s√°ch citation v√† tr·∫°ng th√°i s·ª≠ d·ª•ng") %>%
  autofit()

```


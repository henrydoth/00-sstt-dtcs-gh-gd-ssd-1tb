---
title: "ğŸ“– Danh má»¥c tÃ i liá»‡u tham kháº£o theo AMA11"
author: "Henry Do"
date: today
format:
  html:
    self-contained: true
    toc: true
    toc-location: right
    bibliography: cleaned_references_final.bib
    csl: ama.csl
    number-sections: true
    citation-location: margin
    code-fold: true
    code-summary: "Hiá»ƒn thá»‹/RÃºt gá»n mÃ£ R"
editor: source
---

## ğŸ“† Náº¡p thÆ° viá»‡n phÃ¢n tÃ­ch citation
```{r}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(bib2df, tidyverse, flextable, officer, glue, scales, rvg, forcats, citr)
```

## ğŸ“‚ Äá»c bib file vÃ o dataframe
```{r}
if (!file.exists("sstt_reference.bib")) stop("âš ï¸ File 'sstt_reference.bib' khÃ´ng tá»“n táº¡i!")

bib_lines <- readLines("sstt_reference.bib")
bib_line_index <- which(str_detect(bib_lines, "^@"))

bib_raw <- bib2df("sstt_reference.bib")
stopifnot(length(bib_line_index) == nrow(bib_raw))

tltk <- bib_raw %>% mutate(Line = bib_line_index)

glue("ğŸ“ Gáº¯n thÃ nh cÃ´ng sá»‘ dÃ²ng tá»« file .bib vÃ o {nrow(tltk)} má»¥c.")
```

## ğŸ”– Báº£ng danh má»¥c tÃ i liá»‡u Ä‘á»‹nh dáº¡ng AMA Ä‘Æ¡n giáº£n + dÃ²ng + loáº¡i @entry
```{r}
ref_table <- tltk %>%
  mutate(
    AUTHOR = map_chr(AUTHOR, ~ if (is.null(.x)) NA_character_ else str_c(.x, collapse = ", ")),
    TITLE = str_trim(TITLE),
    JOURNAL = coalesce(JOURNAL, PUBLISHER),
    YEAR = as.character(YEAR),
    ENTRYTYPE = CATEGORY,
    REF_TEXT = glue("{AUTHOR}. {TITLE}. {JOURNAL}. {YEAR}.")
  ) %>%
  mutate(STT = row_number()) %>%
  select(STT, Line, ENTRYTYPE, BIBTEXKEY, REF_TEXT)

flextable(ref_table) %>%
  set_caption("ğŸ“– Danh má»¥c tÃ i liá»‡u tham kháº£o theo AMA11 (cÃ³ sá»‘ dÃ²ng)") %>%
  colformat_int(j = "Line", prefix = "ğŸ“„ DÃ²ng ") %>%
  autofit()
```

### ğŸ“‹ Hiá»ƒn thá»‹ ná»™i dung BibTeX ban Ä‘áº§u (chÆ°a xá»­ lÃ½) vá»›i nÃºt copy
```{r, results='asis'}
raw_text <- readLines("sstt_reference.bib")
cat("<button onclick=\"navigator.clipboard.writeText(document.getElementById('rawbib').innerText)\">ğŸ“‹ Copy BibTeX</button>")
cat("<pre id='rawbib' style='white-space: pre-wrap; background:#f1f1f1; padding:1em; border:1px solid #ddd;'>")
cat(paste(raw_text, collapse = "\n"))
cat("</pre>")
```

### ğŸ§¹ Xá»­ lÃ½ loáº¡i bá» vÃ  giá»¯ láº¡i citation
```{r}
duplicated_entries <- tltk %>%
  filter(duplicated(str_squish(str_to_lower(TITLE))))

recommend_keep <- duplicated_entries %>%
  group_by(TITLE) %>%
  arrange(desc(!is.na(DOI)), desc(!is.na(JOURNAL)), desc(YEAR)) %>%
  slice(1) %>%
  ungroup()

recommend_drop <- duplicated_entries %>%
  filter(!BIBTEXKEY %in% recommend_keep$BIBTEXKEY)
```

### ğŸ§¾ BÃ¡o cÃ¡o tÃ³m táº¯t cÃ¡c citation bá»‹ trÃ¹ng
```{r}
dup_summary <- duplicated_entries %>%
  mutate(AUTHOR = map_chr(AUTHOR, ~ if (is.null(.x)) NA_character_ else str_c(.x, collapse = ", ")),
         ENTRYTYPE = CATEGORY) %>%
  group_by(TITLE) %>%
  mutate(so_lan = n()) %>%
  ungroup() %>%
  filter(!is.na(TITLE)) %>%
  mutate(STT = row_number()) %>%
  select(STT, Line, ENTRYTYPE, BIBTEXKEY, TITLE, YEAR, JOURNAL, so_lan)

flextable(dup_summary) %>%
  set_caption("ğŸ§¾ BÃ¡o cÃ¡o tÃ³m táº¯t cÃ¡c citation bá»‹ trÃ¹ng (Ä‘áº§y Ä‘á»§ thÃ´ng tin)") %>%
  autofit()
```

### âœ… BÃ¡o cÃ¡o cÃ¡c citation nÃªn giá»¯ láº¡i (Æ°u tiÃªn tá»‘t nháº¥t)
```{r}
flextable(recommend_keep %>% mutate(STT = row_number()) %>% 
  select(STT, Line, BIBTEXKEY, TITLE, YEAR, JOURNAL, DOI)) %>%
  set_caption("âœ… Danh sÃ¡ch cÃ¡c citation nÃªn giá»¯ láº¡i (Æ°u tiÃªn tá»‘t nháº¥t)") %>%
  autofit()
```

### ğŸ’¾ Xuáº¥t file cleaned_references_final.bib khÃ´ng cÃ³ dÃ²ng LINE
```{r}
allowed_cols <- c("CATEGORY", "BIBTEXKEY", "AUTHOR", "TITLE", "JOURNAL", "YEAR", "VOLUME", "NUMBER", "PAGES", "DOI", "PUBLISHER", "BOOKTITLE", "EDITOR", "URL", "NOTE")

# LÃ m sáº¡ch vÃ  giá»¯ cá»™t há»£p lá»‡
tltk_cleaned <- tltk %>% 
  filter(!BIBTEXKEY %in% recommend_drop$BIBTEXKEY) %>% 
  select(any_of(allowed_cols)) %>%
  mutate(across(where(is.character), ~ str_replace_all(.x, "\\}+", "")))

df2bib(tltk_cleaned, file = "cleaned_references_final.bib")
glue("âœ… ÄÃ£ xuáº¥t file cleaned_references_final.bib khÃ´ng chá»©a dÃ²ng 'LINE' vÃ  cá»™t khÃ´ng há»£p lá»‡")
```

### ğŸ“ Xuáº¥t thÃªm file sáº¯p xáº¿p citation theo Ä‘á»™ Æ°u tiÃªn (khÃ´ng loáº¡i bá»)
```{r}
sorted_bib <- tltk %>%
  group_by(TITLE) %>%
  arrange(desc(!is.na(DOI)), desc(!is.na(JOURNAL)), desc(YEAR)) %>%
  ungroup() %>%
  select(any_of(allowed_cols)) %>%
  mutate(across(where(is.character), ~ str_replace_all(.x, "\\}+", "")))

df2bib(sorted_bib, file = "sstt_reference_xap_xep.bib")
glue("ğŸ“¦ ÄÃ£ táº¡o file sáº¯p xáº¿p citation theo Ä‘á»™ Æ°u tiÃªn: 'sstt_reference_xap_xep.bib'")
```

### ğŸ“‹ Hiá»ƒn thá»‹ ná»™i dung BibTeX Ä‘Ã£ sáº¯p xáº¿p theo Æ°u tiÃªn (dáº¡ng text dá»… copy)
```{r, results='asis'}
bib_text_sorted <- capture.output(df2bib(sorted_bib))
cat("<button onclick=\"navigator.clipboard.writeText(document.getElementById('bibtext_sorted').innerText)\">ğŸ“‹ Copy BibTeX</button>")
cat("<pre id='bibtext_sorted' style='white-space: pre-wrap; background:#f9f9f9; padding:1em; border:1px solid #ddd;'>")
cat(paste(bib_text_sorted, collapse = "\n"))
cat("</pre>")
```

### ğŸ“‹ Hiá»ƒn thá»‹ ná»™i dung cleaned_references_final.bib (Ä‘Ã£ loáº¡i trÃ¹ng, cÃ³ thá»ƒ copy)
```{r, results='asis'}
bib_text_cleaned <- readLines("cleaned_references_final.bib")
cat("<button onclick=\"navigator.clipboard.writeText(document.getElementById('bibtext_cleaned').innerText)\">ğŸ“‹ Copy BibTeX</button>")
cat("<pre id='bibtext_cleaned' style='white-space: pre-wrap; background:#f1fff1; padding:1em; border:1px solid #ccc;'>")
cat(paste(bib_text_cleaned, collapse = "\n"))
cat("</pre>")
```

## ğŸ“š Tá»± Ä‘á»™ng chÃ¨n danh má»¥c tham kháº£o

Báº¯t Ä‘áº§u danh má»¥c tham kháº£o táº¡i Ä‘Ã¢y:

::: {.references}
:::
